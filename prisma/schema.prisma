generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================
enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Environment {
  DEVELOPMENT
  STAGING
  PRODUCTION
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

enum ResourceType {
  USER
  WORLD
  SESSION
}

enum LogStatus {
  SUCCESS
  FAILURE
}

// ============================================
// USERS
// ============================================
model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  name                    String
  password_hash           String
  role                    UserRole  @default(USER)
  status                  UserStatus @default(ACTIVE)
  
  // Password change
  force_password_change   Boolean   @default(true)
  password_changed_at     DateTime?
  
  // Rate limiting
  login_attempts          Int       @default(0)
  locked_until            DateTime?
  last_failed_attempt     DateTime?
  
  // Two-Factor Authentication
  two_factor_enabled      Boolean   @default(false)
  two_factor_secret       String?
  two_factor_backup_codes String[]  @default([])
  two_factor_enabled_at   DateTime?
  
  // Timestamps
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt
  last_login_at           DateTime?
  
  // Relations
  owned_worlds            World[]
  audit_logs              AuditLog[]

  @@map("users")
}

// ============================================
// WORLDS
// ============================================
model World {
  id                String       @id @default(cuid())
  name              String       @unique
  slug              String       @unique
  environment       Environment
  version           String
  
  k8s_namespace     String?
  k8s_cluster_name  String?
  rds_host          String?
  rds_schema        String?
  s3_bucket_assets  String?
  git_repo_url      String?
  
  description       String       @default("")
  
  owner_id          String
  owner             User         @relation(fields: [owner_id], references: [id])
  
  created_at        DateTime     @default(now())
  updated_at        DateTime     @updatedAt
  deployed_at       DateTime?
  
  audit_logs        AuditLog[]

  @@map("worlds")
}

// ============================================
// AUDIT LOGS
// ============================================
model AuditLog {
  id                String       @id @default(cuid())
  
  action            AuditAction
  resource_type     ResourceType
  resource_id       String?
  details           Json?
  
  user_id           String?
  user              User?        @relation(fields: [user_id], references: [id], onDelete: SetNull)
  user_email        String?
  user_ip           String?
  user_agent        String?
  
  world_id          String?
  world             World?       @relation(fields: [world_id], references: [id], onDelete: SetNull)
  
  status            LogStatus    @default(SUCCESS)
  error_message     String?
  
  created_at        DateTime     @default(now())
  
    @@index([user_id])
    @@index([world_id])
    @@index([action])
    @@index([created_at])
    @@map("audit_logs")
  }
